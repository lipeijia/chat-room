<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <META HTTP-EQUIV="PRAGMA" CONTENT="NO-CACHE">
<META HTTP-EQUIV="EXPIRES" CONTENT="0">
<META HTTP-EQUIV="CACHE-CONTROL" CONTENT="NO-CACHE">
    <title>hello</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.3/angular.min.js" integrity="sha512-KZmyTq3PLx9EZl0RHShHQuXtrvdJ+m35tuOiwlcZfs/rE7NZv29ygNA8SFCkMXTnYZQK2OX0Gm2qKGfvWEtRXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <script>
        var socket = null;
        let data = null;
        function socket_onopen (){
            console.log('WebSocket connection is open for business, bienvenidos!');
        }
        function socket_onmessage (message){
            let object = JSON.parse(message.data);
           
            if(object.kind == 0){
               
                data = JSON.parse(object.data);
            }
            else if(object.kind == 1){
                data.push(JSON.parse(object.data));
            }
            else if(object.kind == 2){
                console.log(JSON.parse(object.data));

            }
      
        }
        function socket_onclose (){
            console.log('WebSocket connection closed, hasta la pr√≥xima!');
        }
      
        function click1(){
            let name = document.getElementById('input').value;
            socket = new WebSocket('ws://localhost:8080' + '/ws?name='+name);
            socket.onopen = socket_onopen;
            socket.onmessage = socket_onmessage;
            socket.onclose = socket_onclose;
        //     var k = {
        //         kind:0
        //     };
        //    socket.send(JSON.stringify(k));
        }
        angular.module("app", [])
          .controller('Ctrl',  ['$scope', function($scope) {
              var self = this;  
              self.test = [1,2];
              self.socket = null;
              $scope.data = [];
            
            self.click1 = function(){
                
                let name = document.getElementById('input').value;
                self.socket = new WebSocket('ws://localhost:8080' + '/ws?name='+name);
                self.socket.onopen = self.socket_onopen;
                self.socket.onmessage = self.socket_onmessage;
                self.socket.onclose = self.socket_onclose;
                var a = 1;
              
            };
            self.selectName = function(index){
                console.log($scope.data[index].id);
            };
            self.socket_onopen = function (){
                console.log(1);
                console.log('WebSocket connection is open for business, bienvenidos!');
            }
            self.socket_onmessage = function (message){
                let object = JSON.parse(message.data);
                // $scope.data.push(1);
              
                let temp = null;
                if(object.kind == 0){
                    // Array.prototype.push.apply(self.data, JSON.parse(object.data));
                    // self.data.push(JSON.parse(object.data));
                  
                    $scope.$apply(function() {
                    // update goes here
                    // $scope.data.push(JSON.parse(object.data));
                        Array.prototype.push.apply($scope.data, JSON.parse(object.data));
                    });
                    // console.log(self.data);
                    // self.data = JSON.parse(object.data);
                }
                else if(object.kind == 1){
                    // self.data.push(JSON.parse(object.data));
                    $scope.$apply(function() {
                    // update goes here
                        $scope.data.push(JSON.parse(object.data));
                        
                    });
                }
                else if(object.kind == 2){
                    console.log(JSON.parse(object.data));

                }
              
                console.log( $scope.data);
            
                // document.getElementById("id").innerHTML = message.data;
            }
            self.socket_onclose = function (){
                console.log('WebSocket connection closed');
            }
        

            //   self.hello = 'hello123 world';
            //   $scope.hello = 'Whirled';
            //   self.updateHello = function(){
            //       console.log('1111');
            //   };
            //   $scope.updateHello = function(){

            //   };
          }]);
    </script>
    
</head>
<body ng-app="app" ng-controller="Ctrl as ctrl">
<button ng-click="ctrl.click1()">login</button>
<input id="input" type="text">
              
<div ng-repeat="item in data track by $index">
    <span ng-bind="item.name" ng-click="ctrl.selectName($index)"></span>
</div>
</body>
</html>